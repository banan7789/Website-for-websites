<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Site Gallery Uploader + Editor</title>
<meta name="description" content="Mobile-first single-file web app to upload or write HTML, auto-generate preview cards, and open sites in a sandboxed viewer. Data persists locally." />
<style>
  :root{
    --bg:#0f172a;          /* slate-900 */
    --panel:#111827;       /* gray-900 */
    --card:#0b1222;        /* deep blue */
    --muted:#94a3b8;       /* slate-400 */
    --text:#e5e7eb;        /* gray-200 */
    --accent:#22d3ee;      /* cyan-400 */
    --accent-2:#38bdf8;    /* sky-400 */
    --danger:#ef4444;      /* red-500 */
    --ok:#22c55e;          /* green-500 */
    --shadow:0 8px 30px rgba(0,0,0,.35);
    --radius:18px;
    --radius-sm:12px;
    --radius-xs:10px;
    --ring:0 0 0 3px rgba(34,211,238,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#0a0f1d 40%,#070b14);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;}
  a{color:inherit}
  button{cursor:pointer}

  /* Header */
  header{
    position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,15,29,.9),rgba(10,15,29,.6));backdrop-filter:blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:12px clamp(12px,3vw,22px);}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-weight:800;letter-spacing:.2px;margin:0;font-size:clamp(18px,4vw,22px);}
  .logo{display:flex;align-items:center;gap:8px}
  .logo .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,var(--accent),var(--accent-2));box-shadow:0 0 20px rgba(34,211,238,.6)}
  .tag{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.1);border-radius:999px;color:var(--muted)}

  .controls{display:flex;gap:8px;margin-left:auto}
  .search{flex:1;min-width:180px;display:flex;gap:8px}
  input[type="search"], select{
    width:100%;padding:12px 12px;border-radius:12px;background:#0c1427;border:1px solid rgba(255,255,255,.07);color:var(--text);
    outline:none
  }
  input[type="search"]:focus, select:focus{box-shadow:var(--ring);border-color:rgba(34,211,238,.35)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0c1427;color:var(--text);
    display:flex;align-items:center;gap:8px}
  .btn.primary{background:linear-gradient(180deg,#0bbbd4,#088caf);border-color:transparent;color:#05222a;font-weight:700}

  /* Upload + Editor */
  .zone{margin:14px auto 0;display:grid;gap:12px}
  .drop{border:1.5px dashed rgba(255,255,255,.15);border-radius:var(--radius);padding:18px;background:rgba(12,20,39,.6);text-align:center;box-shadow:var(--shadow)}
  .drop.highlight{border-color:var(--accent)}
  .drop input{display:none}
  .drop .big{font-size:15px;font-weight:700}
  .sub{color:var(--muted);font-size:12px}

  details.editor{border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);background:rgba(12,20,39,.7);box-shadow:var(--shadow);overflow:hidden}
  details.editor>summary{list-style:none;padding:14px 16px;font-weight:700;cursor:pointer}
  details.editor>summary::-webkit-details-marker{display:none}
  .editor-body{padding:0 12px 12px}
  textarea#code{width:100%;min-height:180px;max-height:50vh;resize:vertical;border-radius:12px;background:#081022;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
  .editor-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

  /* Gallery */
  .grid{display:grid;gap:12px;margin:16px auto;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .card{background:linear-gradient(180deg,#0a1327,#0a1327 60%,#0b142b);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);position:relative}
  .thumb{position:relative;background:#050a17}
  .thumb::after{content:"";position:absolute;inset:0;pointer-events:none;box-shadow:inset 0 -30px 40px rgba(0,0,0,.5)}
  .thumb .stage{position:relative;width:100%;padding-top:65%;overflow:hidden}
  .thumb iframe{position:absolute;inset:0;width:130%;height:130%;transform-origin:0 0;transform:scale(.35);border:0;border-radius:8px;background:#fff}
  .meta{padding:10px 12px}
  .meta h3{margin:0 0 6px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta p{margin:0;color:var(--muted);font-size:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta small{display:block;margin-top:8px;color:#98a3b8}
  .card .actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}
  .iconbtn{border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);color:var(--text);padding:6px 8px;border-radius:10px}

  /* Viewer */
  .viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,7,14,.8);backdrop-filter:blur(6px);z-index:100}
  .viewer.active{display:flex}
  .viewer .panel{position:relative;background:#060b18;border:1px solid rgba(255,255,255,.08);border-radius:16px;width:96vw;height:90vh;max-width:1100px;box-shadow:var(--shadow);display:grid;grid-template-rows:auto 1fr}
  .viewer .bar{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .viewer iframe{width:100%;height:100%;border:0;background:#fff}
  .spacer{flex:1}

  /* Empty state */
  .empty{opacity:.8;text-align:center;color:var(--muted);padding:24px}

  @media (max-width:480px){
    .thumb iframe{transform:scale(.32)}
  }

  @media (prefers-reduced-motion:no-preference){
    .card, .btn, input, select, details{transition:.2s ease}
    .card:active{transform:scale(.995)}
  }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="logo" aria-label="App name">
          <span class="dot" aria-hidden="true"></span>
          <h1>Site Gallery Uploader</h1>
          <span class="tag">Single file â€¢ Offline</span>
        </div>
        <div class="controls" role="group" aria-label="Search and sort">
          <div class="search">
            <input id="q" type="search" placeholder="Search sitesâ€¦ (title/description)" aria-label="Search" />
            <select id="sort" aria-label="Sort">
              <option value="recent">Recent</option>
              <option value="name">Name Aâ†’Z</option>
              <option value="size">Size</option>
            </select>
          </div>
          <button class="btn" id="exportBtn" title="Export gallery JSON">Export</button>
          <label class="btn" title="Import gallery JSON">
            Import
            <input id="importInput" type="file" accept="application/json" />
          </label>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="zone" aria-label="Add sites">
      <label class="drop" id="drop" for="file">
        <input id="file" type="file" accept=".html,.htm" multiple />
        <div class="big">Tap to upload HTML or drag & drop</div>
        <div class="sub">.html / .htm only â€¢ files stay on your device</div>
      </label>

      <details class="editor" id="editor">
        <summary>Builtâ€‘in Code Editor</summary>
        <div class="editor-body">
          <label for="code" class="sub">Write or paste standard HTML below. Click <b>Preview & Save</b> to add it to the gallery.</label>
          <textarea id="code" spellcheck="false" aria-label="HTML code editor"><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hello from the Editor</title>
  <meta name="description" content="A minimal page created inside the app.">
  <style>body{font-family:system-ui;display:grid;place-items:center;height:100vh;margin:0} .card{padding:24px;border:1px solid #ddd;border-radius:12px} .btn{padding:8px 12px;border-radius:10px;border:1px solid #333}</style>
</head>
<body>
  <div class="card">
    <h1>It works! ðŸŽ‰</h1>
    <p>This page was authored in the built-in editor.</p>
    <button class="btn" onclick="alert('Hello!')">Click me</button>
  </div>
</body>
</html></textarea>
          <div class="editor-actions">
            <input id="titleInput" placeholder="Optional title override" class="btn" style="flex:1" aria-label="Title override" />
            <button class="btn primary" id="saveCode">Preview & Save</button>
          </div>
        </div>
      </details>
    </section>

    <section>
      <div class="grid" id="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>
        <p>No sites yet. Upload an HTML file or open the editor above to create one.</p>
      </div>
    </section>
  </main>

  <!-- Viewer Modal -->
  <div class="viewer" id="viewer" role="dialog" aria-modal="true" aria-label="Site viewer">
    <div class="panel">
      <div class="bar">
        <strong id="viewerTitle">Viewer</strong>
        <span class="spacer"></span>
        <button class="btn" id="openNew">Open in new tab</button>
        <button class="btn" id="closeViewer">Close</button>
      </div>
      <iframe id="viewerFrame" sandbox="allow-forms allow-pointer-lock allow-same-origin" referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

<script>
(() => {
  // ===== Utility =====
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const fmtKB = n => (n/1024).toFixed(1) + ' KB';
  const whenIdle = cb => (window.requestIdleCallback||window.requestAnimationFrame)(cb);
  const uid = () => (crypto?.randomUUID?.() || 'id-' + Math.random().toString(36).slice(2));

  // ===== IndexedDB wrapper =====
  const DB_NAME='siteGallery';
  const STORE='sites';
  let dbPromise = null;

  function openDB(){
    if(dbPromise) return dbPromise;
    dbPromise = new Promise((resolve,reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = e => {
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE)){
          const store = db.createObjectStore(STORE, { keyPath:'id' });
          store.createIndex('title','title',{unique:false});
          store.createIndex('added_at','added_at',{unique:false});
          store.createIndex('size_bytes','size_bytes',{unique:false});
        }
      };
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
    });
    return dbPromise;
  }

  async function dbPut(obj){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(STORE,'readwrite');
      tx.objectStore(STORE).put(obj);
      tx.oncomplete = () => res();
      tx.onerror = () => rej(tx.error);
    });
  }
  async function dbGetAll(){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(STORE,'readonly');
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = ()=> res(req.result||[]);
      req.onerror = ()=> rej(req.error);
    });
  }
  async function dbDelete(id){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(STORE,'readwrite');
      tx.objectStore(STORE).delete(id);
      tx.oncomplete = ()=> res();
      tx.onerror = ()=> rej(tx.error);
    });
  }

  // ===== Parsing =====
  function parseHtmlMeta(html, fallbackName){
    try{
      const doc = new DOMParser().parseFromString(html, 'text/html');
      let title = (doc.querySelector('title')?.textContent||'').trim();
      if(!title) title = (doc.querySelector('h1')?.textContent||'').trim();
      if(!title) title = fallbackName || 'Untitled Site';
      let description = doc.querySelector('meta[name="description"]')?.getAttribute('content')||'';
      if(!description){
        const p = [...doc.querySelectorAll('p')].map(x=>x.textContent.trim()).find(t=>t.length>40);
        description = p || 'No description yet.';
      }
      description = description.slice(0,180).trim();
      return { title, description };
    }catch(err){
      return { title: fallbackName || 'Untitled Site', description:'No description yet.' };
    }
  }

  // ===== State & Rendering =====
  let items = []; // memory cache

  function render(){
    const grid = $('#grid');
    const empty = $('#empty');
    const q = $('#q').value.toLowerCase().trim();
    const sort = $('#sort').value;

    let list = items.filter(x => !q || (x.title.toLowerCase().includes(q) || x.description.toLowerCase().includes(q)));
    if(sort==='name') list.sort((a,b)=> a.title.localeCompare(b.title));
    else if(sort==='size') list.sort((a,b)=> (b.size_bytes||0)-(a.size_bytes||0));
    else list.sort((a,b)=> (new Date(b.added_at)) - (new Date(a.added_at)));

    grid.innerHTML='';
    if(!list.length){ empty.hidden=false; return; } else empty.hidden=true;

    const frag = document.createDocumentFragment();
    for(const it of list){
      const card = document.createElement('article');
      card.className='card';
      card.tabIndex=0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label','Open site: '+it.title);
      card.dataset.id = it.id;

      const actions = document.createElement('div');
      actions.className='actions';
      const openBtn = btnIcon('Open');
      const editBtn = btnIcon('Rename');
      const delBtn = btnIcon('Delete');
      actions.append(openBtn, editBtn, delBtn);

      const thumb = document.createElement('div');
      thumb.className='thumb';
      const stage = document.createElement('div');
      stage.className='stage';
      // Lazy iframe creation
      const placeholder = document.createElement('div');
      placeholder.style.cssText='position:absolute;inset:0;display:grid;place-items:center;color:#6b7280;font-size:12px;';
      placeholder.textContent='Preview';
      stage.appendChild(placeholder);
      const meta = document.createElement('div');
      meta.className='meta';
      meta.innerHTML = `<h3 title="${esc(it.title)}">${esc(it.title)}</h3>
                        <p title="${esc(it.description)}">${esc(it.description)}</p>
                        <small>${fmtKB(it.size_bytes||0)} â€¢ ${new Date(it.added_at).toLocaleString()}</small>`;

      thumb.appendChild(stage);
      card.append( actions, thumb, meta );
      frag.appendChild(card);

      // Events
      card.addEventListener('click', e=>{
        if(e.target.closest('.iconbtn')) return; // handled below
        openViewer(it);
      });
      card.addEventListener('keydown', e=>{ if(e.key==='Enter') openViewer(it); });
      openBtn.addEventListener('click', ()=> openViewer(it));
      editBtn.addEventListener('click', async ()=>{
        const newTitle = prompt('Rename title:', it.title);
        if(newTitle && newTitle.trim()){
          it.title = newTitle.trim(); await dbPut(it); render();
        }
      });
      delBtn.addEventListener('click', async ()=>{
        if(confirm('Delete this site?')){ await dbDelete(it.id); items = items.filter(x=>x.id!==it.id); render(); }
      });

      // IntersectionObserver to inject iframe when visible
      observe(stage, () => {
        stage.innerHTML='';
        const ifr = document.createElement('iframe');
        // IMPORTANT: sandbox without allow-scripts for thumbnail
        ifr.setAttribute('sandbox','allow-forms allow-pointer-lock allow-same-origin');
        ifr.setAttribute('referrerpolicy','no-referrer');
        ifr.srcdoc = it.html;
        stage.appendChild(ifr);
      });
    }
    grid.appendChild(frag);
  }

  function btnIcon(label){
    const b = document.createElement('button');
    b.className='iconbtn';
    b.textContent = label;
    b.title = label;
    return b;
  }

  function observe(el, onEnter){
    const io = new IntersectionObserver((entries, obs)=>{
      for(const e of entries){ if(e.isIntersecting){ onEnter(); obs.unobserve(e.target); } }
    }, { rootMargin:'100px' });
    io.observe(el);
  }

  function esc(s=''){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // ===== Add items =====
  async function addFromHtml(html, filename){
    const meta = parseHtmlMeta(html, filename);
    const rec = {
      id: uid(), title: meta.title, description: meta.description,
      html, size_bytes: new TextEncoder().encode(html).length,
      added_at: new Date().toISOString(), last_viewed_at: null
    };
    await dbPut(rec);
    items.unshift(rec);
    render();
  }

  // File input & DnD
  const fileInput = $('#file');
  const drop = $('#drop');

  fileInput.addEventListener('change', async e=>{
    const files = [...e.target.files||[]].filter(f=>/\.html?$/.test(f.name.toLowerCase()));
    for(const f of files){
      const text = await f.text();
      await addFromHtml(text, f.name);
    }
    fileInput.value = '';
  });

  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add('highlight');}));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove('highlight');}));
  drop.addEventListener('drop', async e=>{
    const files = [...e.dataTransfer.files||[]].filter(f=>/\.html?$/.test(f.name.toLowerCase()));
    for(const f of files){ const text = await f.text(); await addFromHtml(text, f.name); }
  });
  drop.addEventListener('click', ()=> fileInput.click());

  // Editor flow
  $('#saveCode').addEventListener('click', async ()=>{
    const html = $('#code').value;
    const titleOverride = $('#titleInput').value.trim();
    await addFromHtml(html, titleOverride || 'Editor Document');
    $('#editor').open = false; $('#titleInput').value='';
  });

  // Search & sort
  $('#q').addEventListener('input', render);
  $('#sort').addEventListener('change', render);

  // Viewer
  const viewer = $('#viewer');
  const viewerFrame = $('#viewerFrame');
  const viewerTitle = $('#viewerTitle');
  $('#closeViewer').addEventListener('click', ()=>{ viewer.classList.remove('active'); viewerFrame.srcdoc=''; });
  viewer.addEventListener('click', e=>{ if(e.target===viewer) $('#closeViewer').click(); });

  function openViewer(it){
    viewerTitle.textContent = it.title;
    // For full view: still sandboxed (no allow-scripts), but same-origin to enable styling
    viewerFrame.setAttribute('sandbox','allow-forms allow-pointer-lock allow-same-origin');
    viewerFrame.srcdoc = it.html;
    viewer.classList.add('active');
    $('#openNew').onclick = ()=>{
      const blob = new Blob([it.html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank', 'noopener');
      setTimeout(()=> URL.revokeObjectURL(url), 30000);
    };
  }

  // Import / Export
  $('#exportBtn').addEventListener('click', async ()=>{
    const data = JSON.stringify(items, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='site-gallery-backup.json';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 30000);
  });
  $('#importInput').addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const text = await f.text();
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('Invalid file');
      for(const it of arr){ if(it && it.id && it.html){ await dbPut(it); } }
      items = await dbGetAll();
      render();
    }catch(err){ alert('Import failed: '+err.message); }
    finally{ e.target.value=''; }
  });

  // ===== Init =====
  (async function init(){
    try{ items = await dbGetAll(); }catch(err){ console.warn('IndexedDB error, falling back to memory only', err); items = []; }
    whenIdle(render);
  })();
})();
</script>
</body>
</html>
